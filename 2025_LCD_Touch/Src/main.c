/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2025 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 ******************************************************************************
 */

#include <stdint.h>
#include <mem_io.h>
#include <clock.h>
#include <gpio.h>
#include <rcc.h>
#include <usart.h>
#include <exti.h>
#include <ltdc.h>
#include <fmc.h>
#include <spi.h>
#include <timer.h>
#include <i2c.h>
#include <lcd_render.h>
#include <button.h>

void delay_us(uint32_t us) {
    for (volatile uint32_t i = 0; i < us * 8 ; ++i) {
        __asm__("nop");
    }
}

int main(void)
{
    // --- system init ---
    system_clock_setup();
    timer_init();
    gpio_init();
    usart_init();
    spi_init();
    ili9341_init();
    ltdc_init();
    exti_init();
    i2c_init();
    i2c_touch_init();

    // debug print LTDC registers
    usart_printf("== LTDC core ==\r\n");
    usart_printf("GCR   = 0x%08X\r\n",  io_read(LTDC_BASE + 0x18));
    usart_printf("SSCR  = 0x%08X\r\n",  io_read(LTDC_BASE + 0x08));
    usart_printf("BPCR  = 0x%08X\r\n",  io_read(LTDC_BASE + 0x0C));
    usart_printf("AWCR  = 0x%08X\r\n",  io_read(LTDC_BASE + 0x10));
    usart_printf("TWCR  = 0x%08X\r\n",  io_read(LTDC_BASE + 0x14));
    usart_printf("BCCR  = 0x%08X\r\n",  io_read(LTDC_BASE + 0x2C));
    usart_printf("SRCR  = 0x%08X\r\n",  io_read(LTDC_BASE + 0x24));

    usart_printf("== Layer1 ==\r\n");
    usart_printf("L1CR   = 0x%08X\r\n",   io_read(LTDC_BASE + 0x84));
    usart_printf("L1WHPCR= 0x%08X\r\n",   io_read(LTDC_BASE + 0x88));
    usart_printf("L1WVPCR= 0x%08X\r\n",   io_read(LTDC_BASE + 0x8C));
    usart_printf("L1PFCR = 0x%08X\r\n",   io_read(LTDC_BASE + 0x94));
    usart_printf("L1CACR = 0x%08X\r\n",   io_read(LTDC_BASE + 0x98));
    usart_printf("L1CFBAR= 0x%08X\r\n",   io_read(LTDC_BASE + 0xAC));
    usart_printf("L1CFBLR= 0x%08X\r\n",   io_read(LTDC_BASE + 0xB0));
    usart_printf("L1CFBLNR= 0x%08X\r\n",  io_read(LTDC_BASE + 0xB4));

    // initial rainbow bars
    bsp_lcd_fill_rect(0xEE82EE, 0, 240, 46*0, 46); // Violet
    bsp_lcd_fill_rect(0x4B0082, 0, 240, 46*1, 46); // Indigo
    bsp_lcd_fill_rect(0x0000FF, 0, 240, 46*2, 46); // Blue
    bsp_lcd_fill_rect(0x008000, 0, 240, 46*3, 46); // Green
    bsp_lcd_fill_rect(0xFFFF00, 0, 240, 46*4, 46); // Yellow
    bsp_lcd_fill_rect(0xFFA500, 0, 240, 46*5, 46); // Orange
    bsp_lcd_fill_rect(0xFF0000, 0, 240, 46*6, 44); // Red

    // --- Initial LED output setup ---
    gpio_set_outdata(GPIOG_BASE, GPIO_PIN_13, green_led_state);   // green LED initial state
    gpio_set_outdata(GPIOG_BASE, GPIO_PIN_14, red_led_state);     // red LED initial state

    while (1) {
        if (button_event_pending) {                    // flag set by EXTI ISR
            button_event_pending = 0;                  // clear button flag
            button_handle_event();                     // process button press
        }

        if (touch_event_pending) {
            touch_event_pending = 0;                   // clear touch flag
            if (touch_state == 0) {
            	touch_handle_event();}                      // process touch event
            i2c_master_write(I2C3_BASE, SLAVE_ADDR7, FIFO_STA_ADDR, FIFO_RESET);
            i2c_master_write(I2C3_BASE, SLAVE_ADDR7, FIFO_STA_ADDR, 0x00);  // release reset
            i2c_master_write(I2C3_BASE, SLAVE_ADDR7, INT_STA_ADDR, 0xFF);   // clear touch INT
        }

        if (touch_state) {
            uint32_t now = micros_now(TIMER2);
            if ((int32_t)(now - touch_until_us) >= 0) { // check if timeout reached
                touch_state = 0;                        // exit touch mode
            }
        }

        lcd_update();                                  // update LCD display
    }
}
